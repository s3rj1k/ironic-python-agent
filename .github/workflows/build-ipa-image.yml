name: Build IPA Image

on:
  push:
    branches:
      - deploy_hook
  workflow_dispatch:

jobs:
  build-ipa-image:
    runs-on: ${{ matrix.runner }}
    outputs:
      amd64-kernel-size: ${{ steps.build-info.outputs.amd64-kernel-size }}
      amd64-initramfs-size: ${{ steps.build-info.outputs.amd64-initramfs-size }}
      arm64-kernel-size: ${{ steps.build-info.outputs.arm64-kernel-size }}
      arm64-initramfs-size: ${{ steps.build-info.outputs.arm64-initramfs-size }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debootstrap \
            dosfstools \
            gdisk \
            kpartx \
            libffi-dev \
            libssl-dev \
            parted \
            python3-dev \
            python3-pip \
            python3-yaml \
            qemu-utils \
            util-linux

      - name: Install diskimage-builder and ironic-python-agent-builder
        run: |
          pip install --user diskimage-builder ironic-python-agent-builder
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install current IPA source
        run: |
          pip install --user -e .

      - name: Copy custom DIB elements
        run: |
          mkdir -p $HOME/.local/share/ironic-python-agent-builder/dib
          cp -vr .github/dib-elements/* $HOME/.local/share/ironic-python-agent-builder/dib/

      - name: Lint shell scripts in deployment-hook element
        run: |
          sudo apt-get install -y shellcheck
          find .github/dib-elements/deployment-hook -name "*.sh" -type f -exec shellcheck {} \;

      - name: Build IPA ramdisk image (amd64)
        if: matrix.arch == 'amd64'
        env:
          DIB_RELEASE: "9-stream"
          DIB_CHECKSUM: "sha256"
          DIB_DHCP_TIMEOUT: "180"
          DIB_PYTHON_EXEC: "/usr/bin/python3"
          DIB_IPA_ENABLE_RESCUE: false
          DIB_DEV_USER_USERNAME: "rescue"
          DIB_DEV_USER_PASSWORD: "rescue"
          DIB_DEV_USER_PWDLESS_SUDO: "yes"
          DIB_REPOLOCATION_ironic_python_agent: "${{ github.workspace }}"
          DIB_REPOREF_ironic_python_agent: "HEAD"
        run: |
          ironic-python-agent-builder \
            -o ipa-amd64 \
            -e extra-hardware \
            -e devuser \
            -e dhclient-systemd \
            -e deployment-hook \
            --extra-args="-a amd64" \
            --release 9-stream centos

      - name: Build IPA ramdisk image (arm64)
        if: matrix.arch == 'arm64'
        env:
          DIB_RELEASE: "9-stream"
          DIB_CHECKSUM: "sha256"
          DIB_DHCP_TIMEOUT: "180"
          DIB_PYTHON_EXEC: "/usr/bin/python3"
          DIB_IPA_ENABLE_RESCUE: false
          DIB_DEV_USER_USERNAME: "rescue"
          DIB_DEV_USER_PASSWORD: "rescue"
          DIB_DEV_USER_PWDLESS_SUDO: "yes"
          DIB_REPOLOCATION_ironic_python_agent: "${{ github.workspace }}"
          DIB_REPOREF_ironic_python_agent: "HEAD"
        run: |
          ironic-python-agent-builder \
            -o ipa-arm64 \
            -e extra-hardware \
            -e devuser \
            -e dhclient-systemd \
            -e deployment-hook \
            --extra-args="-a arm64 --no-tmpfs" \
            --release 9-stream centos

      - name: Verify image artifacts
        run: |
          ls -lh ipa-${{ matrix.arch }}.kernel ipa-${{ matrix.arch }}.initramfs

      - name: Capture build information
        id: build-info
        run: |
          KERNEL_SIZE=$(ls -lh ipa-${{ matrix.arch }}.kernel | awk '{print $5}')
          INITRAMFS_SIZE=$(ls -lh ipa-${{ matrix.arch }}.initramfs | awk '{print $5}')
          echo "${{ matrix.arch }}-kernel-size=${KERNEL_SIZE}" >> $GITHUB_OUTPUT
          echo "${{ matrix.arch }}-initramfs-size=${INITRAMFS_SIZE}" >> $GITHUB_OUTPUT

      - name: Upload IPA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ipa-${{ matrix.arch }}
          path: |
            ipa-${{ matrix.arch }}.kernel
            ipa-${{ matrix.arch }}.initramfs
          retention-days: 1

  build-summary:
    runs-on: ubuntu-latest
    needs: build-ipa-image
    if: always()

    steps:
      - name: Generate aggregated build summary
        run: |
          echo "# IPA Multi-Architecture Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **User**: rescue/rescue" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Kernel | Initramfs |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| amd64 | ${{ needs.build-ipa-image.outputs.amd64-kernel-size }} | ${{ needs.build-ipa-image.outputs.amd64-initramfs-size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| arm64 | ${{ needs.build-ipa-image.outputs.arm64-kernel-size }} | ${{ needs.build-ipa-image.outputs.arm64-initramfs-size }} |" >> $GITHUB_STEP_SUMMARY
